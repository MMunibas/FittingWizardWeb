# Extensibility #

The following sections describe how the services of the fitting system may be extended.

## Calculation Service ##

The most common case for extensibility of the calculation service is to add new types of algorithms. 

The following steps are required to add a new algorithm:
* Create a new python script file in the `algorithms` package, e.g. `mtp-part1.py`
* Define a function with one parameter named `ctx` and decorate with `@register`. The name of the function will be used as the algorithm type, e.g. `mtpfit_part1`
* Write calculation logic within the function using the utility functions provided by the `ctx`. The `ctx` is an object which 
* Restart the service in order to register the new type and use the swagger UI or fitting web to perform tests.

## Fitting Web ##

The fitting web implements two major workflows:
- `MTP Fit using Gaussian`
- `LJ Fit using CHARMM`

Both workflows follow similar concepts which should be followed for new workflows, so we will only point here to the most important things to copy and adapt accordingly.

- `WelcomePage` contains the first selection after the login, which allows the user to select the workflow.
- `session package` contains all pages for session creation (upload of files, definition of default parameters, creation of directories). This is implemented in a wizard style and depends on the workflow. Once a session was created the user is always directed to the overview of the workflow.
  - `ljfit` uploads input files, defines default parameters and saves everything in the `LjFitSessionDir` of the user.
  - `mtpfit` uploads XYZ files and runs the `mtpfit_part1` calculation, which concludes the session creation process. Files are saved in the `MtpFitDir` and `MoleculesDir` of the user.
- `fitting package`
  - `ljfit` allows the user to run a single or multiple `ljfit` calculations which are summarized on an overview page.
  - `mtpfit` allows the user to run a `mtpfit_part2` calculation, which adds an entry to the overview page.
- `commands package`
  - `ljfit` 
    - `RunLjFitsCommand` prepares a `StartDefinition` and a `LjFitRunDir` where all output files will be downloaded to for each run pair parameter.
  - `mtpfit`
    - `RunMtpGenerateFilesCommand` prepares the molecule directory into which the generated files are downloaded. The calculation will not be deleted because fits will run in the same calculation.
    - `RunMtpFitCommand` runs a fit in an existing calculation created when the MTP fit session was created.

### Worked Example: adding "Property X" to the UI for LJ-Fit ###

The hypothetical "Property X" requires:

- An additional file to be uploaded and passed to the "ljfit.py" script
- An additional piece of reference data to be entered and passed to the script
- A new value to be read from the .json file generated by the script
- The new value to be displayed in the UI results table

The following steps could be used to achieve this:
* Add a new input field to the HTML section of fitting/fitting-web/src/main/java/ch/unibas/fitting/web/ljfit/session/CreateNewSessionPage.html as follows:
	<tr>
	   <td>TEST file:</td>
	   <td>
	        <input wicket:id="testUploadFile" type="file" class="btn btn-default" accept=".test" id="testUploadFile"/>
	        <span class="file-custom"></span>
	   </td>
	</tr>
* Add another input field for the reference value of property X
* Modify the corresponding Java code in CreateNewSessionPage.java to add the new fields:

        private final FileUploadField testUploadFile;
        ...
        form.add(testUploadFile = createFileUploadField("testUploadFile"));
        ...
        File testFile = uploadFile(destination, testUploadFile.getFileUpload());
        return new UploadedFileNames(
              testFile,
        ...

        private final IModel<Double> experimentalPropertyX = Model.of();
        ...
        NumberTextField<Double> expectedPropertyXField = new NumberTextField<>("experimentalPropertyX", experimentalPropertyX);
        expectedPropertyXField.setRequired(true);
        expectedPropertyXField.setStep(NumberTextField.ANY);
        expectedPropertyXField.setConvertEmptyInputStringToNull(true);
        expectedPropertyXField.setType(Double.class);
        form.add(expectedPropertyXField);
        ...
        SessionParameter parameter = new SessionParameter(
                 experimentalPropertyX.getObject(),
        ...
* Add the new reference property to application/algorithms/ljfit/SessionParameter.java
* Add new file to application/algorithms/ljfit/UploadedFileNames.java
* Add new file to application/algorithms/ljfit/UploadedFiles.java
* Add new file and property variables to fitting-web/src/main/java/ch/unibas/fitting/web/ljfit/commands/RunLjFitsCommand.java
* Add new property to application/algorithms/ljfit/LjFitRunResult.java:
	public class LjFitRunResult {
    		public final double calcPropertyX,
		expPropertyX,
        ...
	public LjFitRunResult(double calcPropertyX, double expPropertyX ...
	        this.calcPropertyX=calcPropertyX;
        	this.expPropertyX=expPropertyX;
	...
        public LjFitRunResult(LjFitSession session,
                          LjFitRunInput in,
                          LjFitJsonResult jsonResult){
        this(
                jsonResult.propertyX,
                session.getSessionParameter().expectedPropertyX,
		...
* Add property X to results table in web/ljfit/fitting/step2/LjSessionPage.html:
        <td align="center" style="border: 1px solid; width: 60px">&Delta;H<sub>vap.exp</sub></td>
        <td align="center" style="border: 1px solid; width: 60px">Calc Prop X</td>
        <td align="center" style="border: 1px solid; width: 60px">Exp Prop X</td>
	...
        <td align="center" style="border: 1px solid; width: 60px"><span wicket:id="expdeltaH"></span></td>
        <td align="center" style="border: 1px solid; width: 60px"><span wicket:id="calcPropertyX"></span></td>
        <td align="center" style="border: 1px solid; width: 60px"><span wicket:id="expPropertyX"></span></td>
        ...
* Add property to corresponding Java results routine web/ljfit/fitting/step2/LjSessionPage.java:
        item.add(new Label("expdeltaH", format(singleResult.get_expdeltaH(), 2)));
        item.add(new Label("calcPropertyX", format(singleResult.get_calcPropertyX(), 2)));
        item.add(new Label("expPropertyX", format(singleResult.get_expPropertyX(), 2)));
	...
* Add property to web/ljfit/fitting/step2/SingleRunResult.java:
	Double _calcPropertyX, _expPropertyX, ...
	...
        result.result.peek(res -> {
            this._calcPropertyX = res.calcPropertyX;
            this._expPropertyX = res.expPropertyX;
	...
        public Double get_calcPropertyX() { return _calcPropertyX;    }
	public Double get_expPropertyX() { return _expPropertyX;    }
* Add property to json result parsing in application/algorithms/ljfit/LjFitJsonResult.java:
	public final double vaporization_enthalpy;
	public final double propertyX;
	...
	public LjFitJsonResult(JsonObject json) {
	        propertyX = json.get("propertyX").getAsDouble();

* To access these variables from the API to use in the scripts, use values from web/ljfit/commands/RunLjFitsCommand.java, e.g.:
        refPropertyX = float(ctx.parameters["reference_property_x"])
        testFile = ctx.parameters["lj_filename_test_file"]
